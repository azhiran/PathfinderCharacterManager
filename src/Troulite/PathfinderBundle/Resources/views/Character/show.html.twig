{% extends '::base.html.twig' %}

{% import '::popovers.html.twig' as popovers %}

{% block title entity %}

{% block navbar_current -%}
    <ul class="nav navbar-nav">
        <li class="active"><a href="{{ path('characters_show', {'id': entity.id}) }}">{{ 'main.profile'|trans }}</a></li>
        <li><a href="{{ path('character_equipment', {'id': entity.id}) }}">{{ 'equipment'|trans }}</a></li>
        <li><a href="{{ path('character_spells', {'id': entity.id}) }}">{{ 'spells'|trans }}</a></li>
    </ul>
{% endblock %}

{% block content -%}
    {% include('@TroulitePathfinder/Character/character_h1.html.twig') %}
    <div class="row">
        <div class="col-lg-4 col-md-4">
            <h2>{{ 'main.profile'|trans }}</h2>
            <table id="abilities" class="table table-condensed table-striped table-hover table-responsive">
                <thead>
                <tr>
                    <th>{{ 'ability'|trans }}</th>
                    <th>{{ 'value'|trans }}</th>
                    <th>{{ 'modifier' }}</th>
                </tr>
                </thead>
                <tr>
                    <th>{{ 'strength'|trans }}</th>
                    <td>
                        {{ entity.strength }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.strength) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.strength) }}</td>
                </tr>
                <tr>
                    <th>{{ 'dexterity'|trans }}</th>
                    <td>
                        {{ entity.dexterity }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.dexterity) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.dexterity) }}</td>
                </tr>
                <tr>
                    <th>{{ 'constitution'|trans }}</th>
                    <td>
                        {{ entity.constitution }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.constitution) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.constitution) }}</td>
                </tr>
                <tr>
                    <th>{{ 'intelligence'|trans }}</th>
                    <td>
                        {{ entity.intelligence }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.intelligence) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.intelligence) }}</td>
                </tr>
                <tr>
                    <th>{{ 'wisdom'|trans }}</th>
                    <td>
                        {{ entity.wisdom }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.wisdom) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.wisdom) }}</td>
                </tr>
                <tr>
                    <th>{{ 'charisma'|trans }}</th>
                    <td>
                        {{ entity.charisma }}
                        {{ popovers.bonuses(entity.abilitiesBonuses.charisma) }}
                    </td>
                    <td>{{ entity.abilityModifier(entity.charisma) }}</td>
                </tr>
            </table>
            {{ render_esi(controller('TroulitePathfinderBundle:Character:hitPoints', { 'id': entity.id })) }}
        </div>
        <div class="col-lg-4 col-md-4">
            <h2>{{ 'combat'|trans }}</h2>
            <table id="armor" class="table table-striped table-condensed table-responsive">
                <tr>
                    <th>{{ 'ac'|trans }}</th>
                    <td>
                        {{ entity.ac }}
                        {{ popovers.bonuses(entity.defenseBonuses.ac) }}
                    </td>
                </tr>
                <tr>
                    <th>{{ 'touch.ac'|trans }}</th>
                    <td>{{ entity.touchAc }}</td>
                </tr>
                <tr>
                    <th>{{ 'flat.footed.ac'|trans }}</th>
                    <td>{{ entity.flatFootedAc }}</td>
                </tr>
            </table>

            <table id="saving-throws" class="table table-striped table-condensed table-responsive">
                <tr>
                    <th>{{ 'reflexes'|trans }}</th>
                    <td>{{ entity.reflexes }}</td>
                    <td>=</td>
                    <td>{{ entity.baseReflexes }}</td>
                    <td>+</td>
                    <td>{{ entity.abilityModifier(entity.dexterity) }}</td>
                    <td>+</td>
                    <td>
                        {{ entity.defenseBonuses.reflexes }}
                        {{ popovers.bonuses(entity.defenseBonuses.reflexes) }}
                    </td>
                </tr>
                <tr>
                    <th>{{ 'fortitude'|trans }}</th>
                    <td>{{ entity.fortitude }}</td>
                    <td>=</td>
                    <td>{{ entity.baseFortitude }}</td>
                    <td>+</td>
                    <td>{{ entity.abilityModifier(entity.constitution) }}</td>
                    <td>+</td>
                    <td>
                        {{ entity.defenseBonuses.fortitude }}
                        {{ popovers.bonuses(entity.defenseBonuses.fortitude) }}
                    </td>
                </tr>
                <tr>
                    <th>{{ 'will'|trans }}</th>
                    <td>{{ entity.will }}</td>
                    <td>=</td>
                    <td>{{ entity.baseWill }}</td>
                    <td>+</td>
                    <td>{{ entity.abilityModifier(entity.wisdom) }}</td>
                    <td>+</td>
                    <td>
                        {{ entity.defenseBonuses.will }}
                        {{ popovers.bonuses(entity.defenseBonuses.will) }}
                    </td>
                </tr>
            </table>
            <table id="attack-rolls" class="table table-striped table-hover table-condensed table-responsive">
                <tr>
                    <th>{{ 'bab'|trans }}</th>
                    <td>{{ entity.bab }}</td>
                    {% if entity.bab > 5 -%}
                        <td>{{ entity.bab - 5 }}</td>{% endif %}
                    {% if entity.bab > 10 -%}
                        <td>{{ entity.bab - 10 }}</td>{% endif %}
                    {% if entity.bab > 15 -%}
                        <td>{{ entity.bab - 15 }}</td>{% endif %}
                </tr>
                <tr>
                    <th>{{ 'melee.attack.rolls'|trans }}</th>
                    {% for ar in entity.meleeAttackRoll %}
                        <td>
                            {{ ar }}
                            {% if loop.index == loop.length %}
                                {{ popovers.bonuses(entity.attackBonuses.meleeAttackRolls) }}
                            {% endif %}

                        </td>
                    {% endfor %}
                </tr>
                <tr>
                    <th>{{ 'ranged.attack.rolls'|trans }}</th>
                    {% for ar in entity.rangedAttackRoll %}
                        <td>
                            {{ ar }}
                            {% if loop.index == loop.length %}
                                {{ popovers.bonuses(entity.attackBonuses.rangedAttackRolls) }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            </table>
            <table id="damage-bonus" class="table table-striped table-hover table-condensed table-responsive">
                <tr>
                    <th>{{ 'melee.damage.bonus'|trans }}</th>
                    <td>
                        {% if entity.meleeDamageRoll > 0 %}+{% endif %}{{ entity.meleeDamageRoll }}
                        {{ popovers.bonuses(entity.attackBonuses.meleeDamage) }}
                    </td>
                </tr>
                <tr>
                    <th>{{ 'ranged.damage.bonus'|trans }}</th>
                    <td>
                        {% if entity.rangedAttackRoll > 0 %}+{% endif %}{{ entity.rangedDamageRoll }}
                        {{ popovers.bonuses(entity.attackBonuses.rangedDamage) }}
                    </td>
                </tr>
            </table>
            <table id="initiative" class="table table-hover table-condensed table-responsive">
                <tr>
                    <th>{{ 'initiative'|trans }}</th>
                    <td>{{ entity.initiative }}</td>
                    <td>=</td>
                    <td>{{ entity.abilityModifier(entity.dexterity) }}</td>
                    <td>+</td>
                    <td>
                        {{ entity.attackBonuses.initiative.bonus }}
                        {{ popovers.bonuses(entity.attackBonuses.initiative) }}
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-lg-4 col-md-4">
            <h2 id="feats">{{ 'powers'|trans }}</h2>
            {% if
            powers_activation_form.feats|length > 0 or
            powers_activation_form.class_powers|length > 0 or
            powers_activation_form.spell_effects|length > 0 %}
                {{ form_start(powers_activation_form) }}
                {{ form_errors(powers_activation_form) }}
                <table class="table table-hover table-condensed table-responsive">
                    <tbody>
                    {% for power in powers_activation_form.feats %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'feats'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(power.vars.value.feat.name, power.vars.value.feat) }}
                                {{ form_label(power.active, power.vars.value.feat.name) }}
                            </td>
                            <td>{{ form_widget(power.active) }}</td>
                        </tr>
                    {% endfor %}
                    {% for power in powers_activation_form.class_powers %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'class.powers'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(power.vars.value.classPower.name, power.vars.value.classPower) }}
                                {{ form_label(power.active, power.vars.value.classPower.name) }}
                            </td>
                            <td>
                                {{ form_widget(power.active) }}
                                {% if power.cancel is defined %}
                                    {{ form_row(power.cancel) }}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    {% for spellEffect in powers_activation_form.spell_effects %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'spells'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(spellEffect.vars.value.spell.name, spellEffect.vars.value.spell) }}
                                {{ form_label(spellEffect.active, spellEffect.vars.value.spell.name) }}
                            </td>
                            <td>{{ form_widget(spellEffect.active) }}</td>
                        </tr>
                    {% endfor %}
                    {% for powerEffect in powers_activation_form.power_effects %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'powers'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(powerEffect.vars.value.power.name, powerEffect.vars.value.power) }}
                                {{ form_label(powerEffect.active, powerEffect.vars.value.power.name) }}
                            </td>
                            <td>{{ form_widget(powerEffect.active) }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {{ form_row(powers_activation_form._token) }}
                {{ form_row(powers_activation_form.submit) }}
                {{ form_end(powers_activation_form, {'render_rest': false}) }}
            {% endif %}
        </div>
        </div>
        <div class="row">
        <div id="skills" class="col-lg-4 col-md-4">
            <h2>{{ 'skills'|trans }}</h2>
            <table class="table table-hover table-striped table-condensed table-responsive">
                <thead>
                <tr>
                    <th><a href="{{ path('skills') }}">{{ 'skill'|trans }}</a></th>
                    <th>{{ 'total.bonus'|trans }}</th>
                    <th>{{ 'ability.modifier'|trans }}</th>
                    <th>{{ 'ranks'|trans }}</th>
                    <th>{{ 'misc.modifiers'|trans }}</th>
                </tr>
                </thead>
                <tbody>
                {% for skill in skills if (skill.untrained or entity.skillRank(skill) > 0) %}
                    {% set value = 0 %}
                    {% set bonus = 0 %}
                    {%- set shortname = skill.shortname -%}
                    {%- spaceless -%}
                        {% set value = entity.modifierByAbility(skill.keyAbility, entity) + entity.skillRank(skill) %}
                        {% if entity.hasClassBonus(skill) and entity.skillRank(skill) > 0 %}
                            {% set value = value + 3 %}
                        {% endif %}
                        {% if attribute(entity.skillsBonuses, shortname) is defined %}
                            {% set bonus = attribute(entity.skillsBonuses, shortname).bonus %}
                            {% set value = value + bonus %}
                        {% endif %}
                    {%- endspaceless -%}
                    <tr>
                        <td>
                            {% if entity.hasClassBonus(skill) -%}
                                <span class="glyphicon glyphicon-check"></span>
                            {% else %}
                                <span class="glyphicon glyphicon-unchecked"></span>
                            {% endif %}
                            {{ skill }}
                        </td>
                        <td>{{ value }}</td>
                        <td>{{ skill.keyAbility }} {{ entity.modifierByAbility(skill.keyAbility, entity) }}</td>
                        <td>{{ entity.skillRank(skill) }}</td>
                        <td>
                            {{ bonus|default(0) }}
                            {% if attribute(entity.skillsBonuses, shortname) is defined %}
                                {{ popovers.bonuses(entity.skillsBonuses[shortname]) }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-4 col-md-4">
            <h3>{{ 'unmanaged.powers'|trans }}</h3>
            <table class="table table-hover table-condensed table-responsive">
                <tbody>
                {% for feat in other_feats %}
                    <tr>
                        {% if loop.index == 1 %}
                            <th rowspan="{{ loop.length }}">{{ 'feats'|trans }}</th>
                        {% endif %}
                        <td>
                            {{ popovers.description(feat.feat.name, feat.feat) }}
                            {{ feat.feat }}
                        </td>
                    </tr>
                {% endfor %}
                {% for power in other_class_powers %}
                    <tr>
                        {% if loop.index == 1 %}
                            <th rowspan="{{ loop.length }}">{{ 'class.powers'|trans }}</th>
                        {% endif %}
                        <td>
                            {{ popovers.description(power.classPower.name, power.classPower) }}
                            {{ power.classPower }}
                        </td>
                    </tr>
                {% endfor %}
                {% for spellEffect in other_spell_effects %}
                    <tr>
                        {% if loop.index == 1 %}
                            <th rowspan="{{ loop.length }}">{{ 'spells'|trans }}</th>
                        {% endif %}
                        <td>
                            {{ popovers.description(spellEffect.spell.name, spellEffect.spell) }}
                            {{ spellEffect.spell }}
                        </td>
                    </tr>
                {% endfor %}
                {% for powerEffect in other_power_effects %}
                    <tr>
                        {% if loop.index == 1 %}
                            <th rowspan="{{ loop.length }}">{{ 'powers'|trans }}</th>
                        {% endif %}
                        <td>
                            {{ popovers.description(powerEffect.power.name, powerEffect.spell) }}
                            {{ spellEffect.power }}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-lg-4 col-md-4">
            <h3>{{ 'passive.powers'|trans }}</h3>
            <table class="table table-hover table-condensed table-responsive">
                <tbody>
                    {% for feat in passive_feats %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'feats'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(feat.feat.name, feat.feat) }}
                                {{ feat.feat }}
                            </td>
                        </tr>
                    {% endfor %}
                    {% for power in passive_class_powers %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'class.powers'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(power.classPower.name, power.classPower) }}
                                {{ power.classPower }} ({{ power.extraInformation }})
                            </td>
                        </tr>
                    {% endfor %}
                    {% for spellEffect in passive_spell_effects %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'spells'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(spellEffect.spell.name, spellEffect.spell) }}
                                {{ spellEffect.spell }}
                            </td>
                        </tr>
                    {% endfor %}
                    {% for powerEffect in passive_power_effects %}
                        <tr>
                            {% if loop.index == 1 %}
                                <th rowspan="{{ loop.length }}">{{ 'powers'|trans }}</th>
                            {% endif %}
                            <td>
                                {{ popovers.description(powerEffect.power.name, powerEffect.power) }}
                                {{ powerEffect.power }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
